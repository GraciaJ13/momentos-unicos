{% extends "paginaprincipal.html" %} <!-- Cambié a base.html para consistencia con otros templates -->

{% block title %}Gestión de Regalos{% endblock %}

{% block content %}
  <h2>Lista de Regalos</h2>
  <ul>
    {% for regalo in regalos %}
      <li>{{ regalo.nombre }} - Precio: {{ regalo.precio }} - Estado: {{ regalo.estado }} <a href="#">Editar</a> <a href="#">Eliminar</a></li>
    {% endfor %}
  </ul>

  <h3>Agregar Regalo</h3>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Agregar</button>
  </form>

  <!-- Opcional: Formulario para subir archivo Excel -->
  <h3>Subir Lista de Regalos (Excel)</h3>
  <form id="uploadForm">
    <input type="file" id="excelFile" accept=".xlsx, .xls">
    <button type="button" onclick="processExcel()">Procesar</button>
  </form>
  <div id="result"></div>

  <!-- Incluir librería XLSX via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="text/javascript">
    var gk_isXlsx = true;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};

    function filledCell(cell) {
      return cell !== '' && cell != null;
    }

    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];

          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));

          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }

          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }

    function processExcel() {
      var fileInput = document.getElementById('excelFile');
      var file = fileInput.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var data = e.target.result;
          var workbook = XLSX.read(data, { type: 'binary' });
          var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          var jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          document.getElementById('result').innerText = JSON.stringify(jsonData, null, 2);
        };
        reader.readAsBinaryString(file);
      } else {
        alert('Por favor, selecciona un archivo.');
      }
    }
  </script>
{% endblock %}